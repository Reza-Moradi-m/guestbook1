<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astronomy Guestbook</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjQvmQKE77NmdCNMjwQ9D8dEtxdo0ZrUc",
            authDomain: "astronomy-guestbook.firebaseapp.com",
            projectId: "astronomy-guestbook",
            storageBucket: "astronomy-guestbook.firebasestorage.app",
            messagingSenderId: "680979689903",
            appId: "1:680979689903:web:b31210872fff1d641b7f5a",
            measurementId: "G-LDFCYT5NGY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();
    </script>
    <link rel="stylesheet" href="CSS/styles.css">
</head>
<body>
    <header>
        <img id="logo" src="images/logo.jpg" alt="Logo">
        <h1>Astronomy Guestbook</h1>
        <nav id="main-nav">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="guestbook.html">Guestbook</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <form id="messageForm">
            <input type="text" id="firstName" placeholder="First Name" required>
            <input type="text" id="lastName" placeholder="Last Name" required>
            <textarea id="messageInput" placeholder="Write about the stars, planets, or any cosmic event" required></textarea>
            <label for="fileInput">Upload an image or video:</label>
            <input type="file" id="fileInput" accept="image/*,video/*" required>
            <button type="submit">Submit</button>
        </form>
        <div id="messages"></div>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const messageForm = document.getElementById("messageForm");
            const fileInput = document.getElementById("fileInput");
            const messagesDiv = document.getElementById("messages");

            // Form submission handler
            messageForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const firstName = document.getElementById("firstName").value.trim();
                const lastName = document.getElementById("lastName").value.trim();
                const message = document.getElementById("messageInput").value.trim();
                const file = fileInput.files[0];

                if (!file) {
                    alert("Please upload a file!");
                    return;
                }

                try {
                    // Upload file to Firebase Storage
                    const storageRef = storage.ref(`uploads/${file.name}`);
                    const snapshot = await storageRef.put(file);
                    const fileURL = await snapshot.ref.getDownloadURL();

                    // Save message and file URL to Firestore
                    await db.collection("guestbook").add({
                        firstName,
                        lastName,
                        message,
                        fileURL,
                        timestamp: new Date(),
                    });

                    alert("Message and file uploaded successfully!");
                    displayMessages();
                    messageForm.reset();
                } catch (error) {
                    console.error("Error uploading file or saving message:", error);
                    alert("Failed to upload file and save message. Please try again.");
                }
            });

            // Fetch and display messages from Firestore
            async function displayMessages() {
                messagesDiv.innerHTML = ""; // Clear current messages
                try {
                    const querySnapshot = await db.collection("guestbook").orderBy("timestamp", "desc").get();
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const messageElement = document.createElement("div");
                        messageElement.classList.add("message");
                        messageElement.innerHTML = `
                            <p><strong>${data.firstName} ${data.lastName}:</strong> ${data.message}</p>
                            ${data.fileURL ? `<a href="${data.fileURL}" target="_blank">View Attachment</a>` : ""}
                        `;
                        messagesDiv.appendChild(messageElement);
                    });
                } catch (error) {
                    console.error("Error fetching messages:", error);
                    alert("Failed to load messages. Please refresh the page.");
                }
            }

            // Initial call to display messages
            displayMessages();
        });
    </script>
</body>
</html>
